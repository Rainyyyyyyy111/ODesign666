name: Build ODesign SIF (Cloud Relay)

on:
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # 自动获取你的仓库名 (e.g., yourname/odesign)
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ------------------------------------------------------------------
  # 第一棒：构建 Docker 镜像并推送到 GitHub Registry (GHCR)
  # ------------------------------------------------------------------
  build-and-push:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write # 允许写入 GHCR

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true # 关键：推送到云端，不占用本地空间
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ------------------------------------------------------------------
  # 第二棒：在全新的机器上拉取镜像并转换为 SIF
  # ------------------------------------------------------------------
  convert-to-sif:
    needs: build-and-push # 等第一棒跑完
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: read # 允许读取 GHCR

    steps:
      # 1. 再次清理空间（虽然是新机器，但为了保险起见，给 SIF 留足余地）
      - name: Free Disk Space (Corrected)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      # 2. 安装 Apptainer
      - name: Setup Apptainer
        uses: eWaterCycle/setup-apptainer@v2
        with:
          apptainer-version: '1.3.4'

      # 3. 处理镜像名称的小写问题 (GitHub Registry 要求全小写)
      - name: Lowercase Image Name
        run: |
          echo "IMAGE_URI=docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" | tr '[:upper:]' '[:lower:]' >> $GITHUB_ENV

      # 4. 从云端拉取并转换
      - name: Build SIF from Registry
        env:
          # Apptainer 需要权限才能拉取你的私有镜像
          APPTAINER_DOCKER_USERNAME: ${{ github.actor }}
          APPTAINER_DOCKER_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Pulling from: ${{ env.IMAGE_URI }}"
          apptainer build odesign.sif ${{ env.IMAGE_URI }}

      # 5. 上传最终结果
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: odesign-sif
          path: odesign.sif
