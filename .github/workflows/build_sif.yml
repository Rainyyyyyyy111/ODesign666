name: Build ODesign SIF

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    # -------------------------------------------------------
    # ğŸŒŸ æ–°å¢æ­¥éª¤ï¼šæ¸…ç†ç£ç›˜ç©ºé—´ï¼ˆè§£å†³ No space left on deviceï¼‰
    # è¿™ä¼šåˆ é™¤ Android, DotNet ç­‰é¢„è£…è½¯ä»¶ï¼Œè…¾å‡ºçº¦ 30GB ç©ºé—´
    # -------------------------------------------------------
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space-action@v1.3.1
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true

    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 1. æ„å»º Docker é•œåƒ
    - name: Build Docker image (amd64)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        platforms: linux/amd64
        tags: odesign:latest
        load: true  # å¿…é¡»åŠ è½½åˆ°æœ¬åœ° Docker daemonï¼Œå¦åˆ™ä¸‹é¢æ‰¾ä¸åˆ°

    # 2. å®‰è£… Apptainer
    - name: Setup Apptainer
      uses: eWaterCycle/setup-apptainer@v2
      with:
        apptainer-version: '1.3.4'

    # 3. è½¬æ¢ä¸º SIF
    # æ³¨æ„ï¼šå¦‚æœä½ çš„é•œåƒæå…¶å·¨å¤§ï¼Œè¿™ä¸€æ­¥ä¾ç„¶å¯èƒ½æ…¢ï¼Œä½†ç©ºé—´åº”è¯¥å¤Ÿäº†
    - name: Build SIF
      run: |
        apptainer build odesign.sif docker-daemon://odesign:latest

    # 4. ä¸Šä¼ ç»“æœ
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: odesign-sif
        path: odesign.sif
