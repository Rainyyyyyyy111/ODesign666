name: Build ODesign SIF

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    # -------------------------------------------------------
    # ğŸŒŸ ä¿®æ­£ç‚¹ï¼šæ’ä»¶åç§°å»æ‰äº† "-action"
    # è¿™ä¼šè…¾å‡ºçº¦ 30GB ç©ºé—´ï¼Œè§£å†³ No space left on device
    # -------------------------------------------------------
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@v1.3.1
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true

    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # 1. æ„å»º Docker é•œåƒ
    - name: Build Docker image (amd64)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        platforms: linux/amd64
        tags: odesign:latest
        load: true

    # 2. å®‰è£… Apptainer
    - name: Setup Apptainer
      uses: eWaterCycle/setup-apptainer@v2
      with:
        apptainer-version: '1.3.4'

    # 3. è½¬æ¢ä¸º SIF
    - name: Build SIF
      run: |
        apptainer build odesign.sif docker-daemon://odesign:latest

    # 4. ä¸Šä¼ ç»“æœ
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: odesign-sif
        path: odesign.sif
